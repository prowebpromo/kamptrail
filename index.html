<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KampTrail – Free Campsite Map</title>
  <meta name="description" content="KampTrail is a fast, offline-first PWA for finding free and low-cost campsites.">
  <meta name="theme-color" content="#0b141b">

  <!-- PWA / A2HS -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="application-name" content="KampTrail">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">

  <!-- Social cards -->
  <meta property="og:title" content="KampTrail – Free Campsite Map">
  <meta property="og:type" content="website">
  <meta property="og:image" content="og.png">
  <meta property="og:description" content="Fast, offline-first campsite map with clustering and 'near me' shortcuts.">
  <meta property="og:url" content="https://prowebpromo.github.io/kamptrail/">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Networking -->
  <link rel="preconnect" href="https://tile.openstreetmap.org">

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Esri Leaflet (for PAD-US / BLM / USFS overlays) -->
  <script src="https://unpkg.com/esri-leaflet@3/dist/esri-leaflet.js"></script>

  <!-- Overlays bundle (advanced) -->
  <link rel="stylesheet" href="overlays/overlays-advanced.css">

  <style>
    html, body {height:100%; margin:0; background:#0b141b; color:#e8f0f7; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;}
    #app {display:grid; grid-template-rows: auto 1fr auto; height: 100%;}
    header {padding: 10px 12px; display:flex; align-items:center; gap:10px; background:#0f1b24; position: sticky; top:0; z-index: 10;}
    header h1 {font-size: 16px; margin:0;}
    header .btn {border:1px solid #22313f; padding:6px 10px; border-radius:10px; background:#15232e; color:#cfe3f2; cursor:pointer;}
    #map {height: calc(100vh - 92px);} /* header + footer */
    footer {padding:8px 12px; font-size:12px; color:#b7c7d6; background:#0f1b24; border-top:1px solid #22313f;}
    .toast {position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); background:#173243; padding:10px 14px; border-radius:12px; border:1px solid #284356; display:none;}
    .toast.show {display:block;}
    a {color:#9fd0ff;}
    /* A11y defaults */
    *:focus-visible {outline: 3px solid #86b7ff; outline-offset: 2px;}
    @media (prefers-reduced-motion: reduce){ * {animation: none !important; transition: none !important;} }
    .leaflet-container {background:#0b141b;}
    /* Desync guards */
    html, body, #app, #map { zoom: 1 !important; transform: none !important; }
    .leaflet-container { will-change: transform; }
    .leaflet-pane, .leaflet-map-pane, .leaflet-tile-pane, .leaflet-marker-pane { transform: translateZ(0); }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>KampTrail</h1>
      <button id="near" class="btn" aria-label="Find campsites near me" aria-pressed="false">Near me</button>
      <button id="free" class="btn" aria-label="Filter to free campsites" aria-pressed="false">Free</button>
      <span style="margin-left:auto;font-size:12px;opacity:.7">Offline-ready</span>
    </header>

    <div id="map" role="region" aria-label="Campsite map" tabindex="0"></div>

    <footer>
      Map © OpenStreetMap contributors · Data: OSM / USGS PAD-US / BLM / USFS
    </footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">New version ready — <a href="#" id="update">update now</a></div>

  <script>
  // Service Worker registration with update toast
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').then(reg => {
        function promptUpdate(sw){
          const t = document.getElementById('toast');
          t.classList.add('show');
          document.getElementById('update').onclick = (e) => {
            e.preventDefault();
            sw.postMessage('SKIP_WAITING');
            window.location.reload();
          };
        }
        if (reg.waiting) promptUpdate(reg.waiting);
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          sw && sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && navigator.serviceWorker.controller) promptUpdate(sw);
          });
        });
      }).catch(console.error);
    });
  }

  // Map init
  const map = L.map('map', { zoomControl: true }).setView([39.8283, -98.5795], 5);

  // Tiles
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    detectRetina: true,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Cluster group (reserved for any ad-hoc markers you add later)
  const cluster = L.markerClusterGroup({chunkedLoading:true, spiderfyOnMaxZoom:false});
  map.addLayer(cluster);

  // Keep layout correct on first paint / resize / tab focus
  setTimeout(() => map.invalidateSize(), 300);
  window.addEventListener('resize', () => map.invalidateSize());
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') map.invalidateSize();
  });

  // Buttons
  const nearBtn = document.getElementById('near');
  const freeBtn = document.getElementById('free');

  nearBtn.addEventListener('click', () => {
    nearBtn.setAttribute('aria-pressed', nearBtn.getAttribute('aria-pressed') === 'true' ? 'false' : 'true');
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      map.setView([latitude, longitude], 11);
      L.circle([latitude, longitude], {radius: 5000}).addTo(map);
    }, err => alert('Location error: ' + err.message), {enableHighAccuracy:true, timeout:8000});
  });

  freeBtn.addEventListener('click', () => {
    const pressed = freeBtn.getAttribute('aria-pressed') === 'true';
    freeBtn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
    // Placeholder: hook real filter later
    map.fitBounds([[33, -117],[34, -115]]);
  });

  // URL shortcuts
  const params = new URLSearchParams(location.search);
  if (params.get('shortcut') === 'near') nearBtn.click();
  if (params.get('filter') === 'free')  freeBtn.click();
  </script>

  <!-- Advanced overlays: panel + loaders -->
  <script src="overlays/overlays-advanced.js"></script>
  <script>
    KampTrailAdvanced.init(map, {
      // openCellIdToken: 'YOUR_OPENCELLID_TOKEN' // optional
    });
  </script>
</body>
</html>

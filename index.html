<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KampTrail – Free Campsite Map</title>
  <meta name="description" content="KampTrail is a fast, offline-first PWA for finding free and low-cost campsites.">
  <meta name="theme-color" content="#0b141b">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta property="og:title" content="KampTrail – Free Campsite Map">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/og.png">
  <meta property="og:description" content="Fast, offline-first campsite map with clustering and 'near me' shortcuts.">

  <!-- Leaflet core (keep versions matched) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    html, body {height:100%; margin:0; background:#0b141b; color:#e8f0f7; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;}
    #app {display:grid; grid-template-rows: auto 1fr; height: 100%;}
    header {padding: 10px 12px; display:flex; align-items:center; gap:10px; background:#0f1b24; position: sticky; top:0; z-index: 10;}
    header h1 {font-size: 16px; margin:0;}
    header .btn {border:1px solid #22313f; padding:6px 10px; border-radius:10px; background:#15232e; color:#cfe3f2;}
    #map {height: calc(100vh - 56px);}
    .toast {position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); background:#173243; padding:10px 14px; border-radius:12px; border:1px solid #284356; display:none;}
    .toast.show {display:block;}
    a {color:#9fd0ff;}
    /* A11y defaults */
    *:focus-visible {outline: 3px solid #86b7ff; outline-offset: 2px;}
    @media (prefers-reduced-motion: reduce){ * {animation: none !important; transition: none !important;} }
    .leaflet-container {background:#0b141b;}

    /* ===== CHG: Desync guards (prevent parent scaling/transform) ===== */
    html, body, #app, #map {
      zoom: 1 !important;           /* avoid CSS zoom-based scaling */
      transform: none !important;   /* no transforms on ancestors */
    }
    .leaflet-container { will-change: transform; }
    .leaflet-pane, .leaflet-map-pane, .leaflet-tile-pane, .leaflet-marker-pane {
      transform: translateZ(0);     /* keep GPU path consistent */
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>KampTrail</h1>
      <button id="near" class="btn" aria-label="Find campsites near me">Near me</button>
      <button id="free" class="btn" aria-label="Filter to free campsites">Free</button>
      <span style="margin-left:auto;font-size:12px;opacity:.7">Offline-ready</span>
    </header>
    <div id="map" role="region" aria-label="Campsite map"></div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite">New version ready — <a href="#" id="update">update now</a></div>

  <script>
  // Service Worker registration with update flow
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        function promptUpdate(sw){
          const t = document.getElementById('toast');
          t.classList.add('show');
          document.getElementById('update').onclick = (e) => {
            e.preventDefault();
            sw.postMessage('SKIP_WAITING');
            window.location.reload();
          };
        }
        if (reg.waiting) promptUpdate(reg.waiting);
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          sw && sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && navigator.serviceWorker.controller) promptUpdate(sw);
          });
        });
      }).catch(console.error);
    });
  }

  // Map init
  const map = L.map('map', {
    zoomControl: true
    // CHG: you could add zoomSnap: 1 if you ever see fractional zooms from trackpads
  }).setView([39.8283, -98.5795], 4); // CONUS

  // Tiles (Edit to use your provider/key if needed)
  const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    detectRetina: true,                     // CHG: better alignment on high-DPI
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Cluster group
  const cluster = L.markerClusterGroup({chunkedLoading:true, spiderfyOnMaxZoom:false});
  map.addLayer(cluster);

  // Dummy data (replace with real data loader by bbox/region)
  function addMarkers(n=2000) {
    for (let i=0;i<n;i++){
      const lat = 25 + Math.random()*20;
      const lng = -125 + Math.random()*30;
      const m = L.marker([lat, lng], {title: 'Campsite #' + i});
      m.bindPopup('<strong>Campsite #' + i + '</strong><br>Type: Free');
      cluster.addLayer(m);
    }
  }
  addMarkers(1500);

  // ===== CHG: force layout recalcs (prevents desync after first paint / resizes)
  setTimeout(() => map.invalidateSize(), 300);
  window.addEventListener('resize', () => map.invalidateSize());
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') map.invalidateSize();
  });

  // Shortcuts
  const params = new URLSearchParams(location.search);
  if (params.get('shortcut') === 'near') document.getElementById('near').click();
  if (params.get('filter') === 'free') document.getElementById('free').click();

  document.getElementById('near').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      map.setView([latitude, longitude], 11);
      L.circle([latitude, longitude], {radius: 5000}).addTo(map);
    }, err => alert('Location error: ' + err.message), {enableHighAccuracy:true, timeout:8000});
  });

  document.getElementById('free').addEventListener('click', () => {
    // Placeholder: hook your real filter; for demo, zoom to random bbox
    map.fitBounds([[33, -117],[34,-115]]);
  });
  </script>
</body>
</html>

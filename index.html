<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KampTrail ‚Äî Free Campsite Map</title>
  <meta name="description" content="Find free and low-cost campsites across the US with advanced filters, overlays, and trip planning.">
  <meta name="theme-color" content="#0b141b">

  <!-- PWA / A2HS -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="application-name" content="KampTrail">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">

  <!-- Social -->
  <meta property="og:title" content="KampTrail ‚Äî Free Campsite Map">
  <meta property="og:type" content="website">
  <meta property="og:image" content="og.png">
  <meta property="og:description" content="Fast, offline-first campsite map with overlays, filters, and trip planning.">
  <meta property="og:url" content="https://prowebpromo.github.io/kamptrail/">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Networking hint -->
  <link rel="preconnect" href="https://tile.openstreetmap.org">

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Esri Leaflet (for PAD-US/BLM/USFS services used by overlays-advanced.js) -->
  <script src="https://unpkg.com/esri-leaflet@3/dist/esri-leaflet.js"></script>

  <!-- Overlays UI styles -->
  <link rel="stylesheet" href="overlays/overlays-advanced.css">
  <link rel="stylesheet" href="overlays/overlays.css">

  <style>
    .kt-controls label:last-child {
      border-top: 1px solid #22313f;
      padding-top: 5px;
      margin-top: 5px;
    }
    :root{--c-bg:#0b141b;--c-panel:#0f1b24;--c-border:#22313f;--c-accent:#86b7ff;--c-text:#e8f0f7;--c-sub:#9fd0ff;}
    html,body{height:100%;margin:0;background:var(--c-bg);color:var(--c-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    #app{display:grid;grid-template-rows:auto 1fr auto;height:100%}
    header{position:sticky;top:0;z-index:1000;display:flex;gap:10px;align-items:center;padding:10px 12px;background:var(--c-panel);border-bottom:1px solid var(--c-border)}
    header h1{margin:0;font-size:16px;font-weight:700}
    .actions{margin-left:auto;display:flex;gap:8px}
    .btn{border:1px solid var(--c-border);background:#15232e;color:#cfe3f2;padding:6px 12px;border-radius:10px;cursor:pointer;font-size:13px}
    .btn:hover{background:#1f3d52;border-color:#284356}
    .btn.active{background:#173243;border-color:var(--c-accent);color:var(--c-sub)}
    #map{height:calc(100vh - 92px)}
    footer{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--c-panel);border-top:1px solid var(--c-border);font-size:12px;color:#b7c7d6}
    footer a{color:var(--c-sub);text-decoration:none}
    footer a:hover{text-decoration:underline}

    /* Toast & loading */
    .toast{position:fixed;left:50%;bottom:70px;transform:translateX(-50%);display:none;z-index:2000;background:#173243;border:1px solid #284356;border-radius:12px;padding:12px 16px;max-width:90vw;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .toast.show{display:block}
    .toast.success{border-color:#00b894;background:#0e3329}
    .toast.error{border-color:#ff6b6b;background:#3d1a1a}
    .loading{position:fixed;inset:auto 0 0 0;top:0;display:none;place-items:center;background:rgba(11,20,27,.35);z-index:-1}
    .loading.show{display:grid}
    .spinner{border:3px solid #284356;border-top:3px solid var(--c-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Map perf guards */
    html,body,#app,#map{zoom:1!important;transform:none!important}
    .leaflet-container{background:var(--c-bg);will-change:transform}
    .leaflet-pane,.leaflet-map-pane,.leaflet-tile-pane,.leaflet-marker-pane{transform:translateZ(0)}

    @media (max-width:768px){header{flex-wrap:wrap}.actions{width:100%;justify-content:flex-end}}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>üèïÔ∏è KampTrail</h1>
      <div class="actions">
        <button id="filters" class="btn" aria-label="Open filters">
          üîç Filters
          <span id="filter-badge" style="display:none;background:#ff6b6b;color:#fff;border-radius:999px;padding:2px 6px;font-size:10px;margin-left:4px;"></span>
        </button>
        <button id="trip" class="btn" aria-label="Open trip planner">üß≠ My Trip <span id="trip-count">(0)</span></button>
        <button id="near" class="btn" aria-label="Find campsites near me" aria-pressed="false">üìç Near me</button>
      </div>
    </header>

    <div id="map" role="region" aria-label="Campsite map" tabindex="0"></div>

    <footer>
      <div>
        Map ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors ¬∑
        Data: PAD-US / BLM / USFS / community datasets
      </div>
      <div>
        <a href="https://github.com/prowebpromo/kamptrail" target="_blank" rel="noopener">Open Source</a> ¬∑
        <span id="status-dot" style="color:#00b894">‚óè</span>
        <span id="status-text">Online</span>
      </div>
    </footer>
  </div>

  <!-- Toast + Loading -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loading" class="loading"><div class="spinner"></div></div>

  <script>
    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').then(reg => {
          function promptUpdate(sw){
            showToast('New version available ‚Äî <a href="#" id="upd">update now</a>', 'success', 0, true);
            document.getElementById('upd').onclick = (e) => {
              e.preventDefault(); sw.postMessage('SKIP_WAITING'); location.reload();
            };
          }
          if (reg.waiting) promptUpdate(reg.waiting);
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            sw && sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) promptUpdate(sw);
            });
          });
        }).catch(console.error);
      });
    }

    // Helpers
    window.escapeHtml = function(text){
      if(!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };
    function showToast(msg, type='info', ms=5000, isHtml=false){
      const t=document.getElementById('toast');
      if(isHtml) t.innerHTML=msg;
      else t.textContent=msg;
      t.className='toast show '+type;
      if(ms>0) setTimeout(()=>t.classList.remove('show'), ms);
    }
    function setLoading(on){document.getElementById('loading').classList.toggle('show', !!on)}
    function updateOnline(){
      const d=document.getElementById('status-dot'),s=document.getElementById('status-text');
      if(navigator.onLine){d.style.color='#00b894';s.textContent='Online';}
      else{d.style.color='#e17055';s.textContent='Offline';}
    }
    window.addEventListener('online',updateOnline);
    window.addEventListener('offline',updateOnline);
    updateOnline();

    // Map init
    const map = L.map('map',{zoomControl:true,preferCanvas:true});
    const saved = (()=>{try{return JSON.parse(localStorage.getItem('kt_last_position'))}catch{return null}})();
    if(saved){map.setView([saved.lat,saved.lng],saved.zoom)}else{map.setView([39.8283,-98.5795],5)}
    map.on('moveend',()=>{
      const c=map.getCenter();
      try{localStorage.setItem('kt_last_position',JSON.stringify({lat:c.lat,lng:c.lng,zoom:map.getZoom()}))}catch{}
    });
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,detectRetina:true,attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    setTimeout(()=>map.invalidateSize(),300);
    window.addEventListener('resize',()=>map.invalidateSize());
    document.addEventListener('visibilitychange',()=>{
      if(document.visibilityState==='visible') map.invalidateSize()
    });

    // Header actions
    document.getElementById('near').addEventListener('click',function(){
      const was=this.classList.contains('active');
      this.classList.toggle('active');
      this.setAttribute('aria-pressed',!was);
      if(was) return;
      if(!navigator.geolocation){
        showToast('Geolocation not supported','error');
        this.classList.remove('active');
        return;
      }
      setLoading(true);
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const {latitude,longitude}=pos.coords;
          map.setView([latitude,longitude],11);
          L.circle([latitude,longitude],{
            radius:5000,color:'#86b7ff',fillColor:'#86b7ff',fillOpacity:.1
          }).addTo(map);
          setLoading(false);
          showToast('üìç Zoomed to your location','success');
        },
        err=>{
          setLoading(false);
          showToast('Location error: '+err.message,'error');
          this.classList.remove('active');
        },
        {enableHighAccuracy:true,timeout:8000}
      );
    });

    // Filters and Trip buttons handled by their respective modules
  </script>

  <!-- Feature modules -->
  <script src="overlays/overlays-advanced.js"></script>
  <script src="overlays/overlays.js"></script>
  <script src="data-loader.js"></script>
  <script src="filters.js"></script>
  <script src="trip-planner.js"></script>
  <script src="gpx-importer.js"></script>
  <script src="campsite-compare.js"></script>

  <!-- Initialize features -->
  <script>
    (async () => {
      try {
        // 1) Overlays - Advanced (base map switcher)
        if (window.KampTrailAdvanced) {
          KampTrailAdvanced.init(map, {});
        }

        // 1b) Overlays - POI layers and public lands
        if (window.KampTrailOverlays) {
          KampTrailOverlays.init(map, {
            publicLandsUrl: 'https://tiles.arcgis.com/tiles/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Protected_Areas/MapServer/tile/{z}/{y}/{x}',
            openCelliDKey: 'pk.40042dae6a477f5db33fb6c59b3ae06b',
            poiUrl: 'https://cdn.jsdelivr.net/gh/prowebpromo/kamptrail@main/data/poi_dump_water_propane.geojson',
            placesUrl: 'data/sample_places.geojson'
          });
        }

        // 2) Campsite data loader
        if (window.KampTrailData) {
          setLoading(true);
          await KampTrailData.init(map, {
            maxMarkers: 5000,
            isFavorite: (id) => {
              try { return (JSON.parse(localStorage.getItem('kt_favorites')||'[]')).includes(id); }
              catch { return false; }
            },
            onTripAdd: (id) => window.KampTrailTrip && KampTrailTrip.addStop(id),
            onFavoriteToggle: (id) => {
              try{
                const favs = JSON.parse(localStorage.getItem('kt_favorites')||'[]');
                const i=favs.indexOf(id);
                i>-1?favs.splice(i,1):favs.push(id);
                localStorage.setItem('kt_favorites',JSON.stringify(favs));
              }catch{}
            }
          });
          setLoading(false);
        }

        // 3) Filters
        if (window.KampTrailFilters) KampTrailFilters.init(map);

        // 4) Trip planner
        if (window.KampTrailTrip) KampTrailTrip.init(map);

        // 5) GPX Importer
        if (window.KampTrailGPX) KampTrailGPX.init(map);

        // 6) Campsite Comparison
        if (window.KampTrailCompare) KampTrailCompare.init(map);

        // Welcome message
        if (!localStorage.getItem('kt_welcomed')) {
          setTimeout(()=>{
            showToast('üëã Welcome! Use Filters to refine sites and My Trip to plan your route.', 'success', 7000);
            localStorage.setItem('kt_welcomed','1');
          }, 800);
        }
      } catch (e) {
        console.error(e);
        setLoading(false);
        showToast('Error loading features. Check console.', 'error', 0);
      }
    })();
  </script>
</body>
</html>
